stages:
    - build
    - docker_build

dev_package:
    stage: build
    image: acastellano/debbuilder
    script:
        - SNAPSHOTDATE=$(date +%G%m%d%k%M%S)
        - dpkg-buildpackage -uc -b
        - mkdir build
        - mv ../*.deb build/
        - PACKAGE=$(ls build)
        - curl -X POST -F file=@build/$PACKAGE http://packages.windmaker.net:8000/api/files/toggl-jira-work-logger
        - curl -X POST http://packages.windmaker.net:8000/api/repos/packages-windmaker-any-testing/file/toggl-jira-work-logger
        - "curl -X POST -H 'Content-Type: application/json' --data '{\"Name\":\"packages-windmaker-any-testing-'\"$SNAPSHOTDATE\"'\"}' http://packages.windmaker.net:8000/api/repos/packages-windmaker-any-testing/snapshots"
        - "curl -X PUT -H 'Content-Type: application/json' --data '{\"Snapshots\": [{\"Component\": \"testing\", \"Name\": \"packages-windmaker-any-testing-'\"$SNAPSHOTDATE\"'\"}]}' http://packages.windmaker.net:8000/api/publish/:./any"
    artifacts:
        paths:
            - build/*

dev_docker_build:
    stage: docker_build
    image: docker:stable
    script:
        - VERSION=$(cat VERSION)
        - docker build -t toggl-jira-work-logger-develop -f Dockerfile-develop .
        - echo $DOCKERHUBPASSWORD | docker login --username acastellano --password-stdin
        - docker create --name=toggl-jira-work-logger-develop -i toggl-jira-work-logger-develop
        - docker commit -m "Develop image for version $VERSION" -a "√Ålvaro Castellano Vela <alvaro.castellano.vela@gmail.com>" debbuilder acastellano/toggl-jira-work-logger-develop
        - docker push acastellano/toggl-jira-work-logger-develop
        - docker stop toggl-jira-work-logger-develop
        - docker rm toggl-jira-work-logger-develop
        - docker rmi toggl-jira-work-logger-develop
